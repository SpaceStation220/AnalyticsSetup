networks:
  logging:

volumes:
  grafana_data: {}
  loki_data: {}
  promtail_positions: {} # To store read positions for log files

services:
  loki:
    image: grafana/loki:2.9.5 # Pinning version is good practice
    container_name: loki
    ports:
      - "3100:3100" # Loki API port
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - logging
    restart: unless-stopped

  agent:
    image: grafana/agent:v0.40.2 # Latest stable version
    container_name: grafana-agent
    volumes:
      # Mount the HOST log directory into the CONTAINER at /var/log/game_logs (read-only)
      - /run/media/furior/Data/ss13/Bandastation/data/logs:/var/log/game_logs:ro # TODO: into env var and multiple sources support
      # Mount the Agent config file
      - ./agent-config.yaml:/etc/agent/agent.yaml:ro
      # Mount volume for positions file (needs write access inside container)
      - promtail_positions:/var/log/agent # Reusing the same volume
    command: -config.file=/etc/agent/agent.yaml
    ports:
      - "12345:12345" # Agent UI port
    networks:
      - logging
    depends_on:
      - loki
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.2 # Pinning version is good practice
    container_name: grafana
    ports:
      - "3000:3000" # Grafana Web UI port
    volumes:
      - grafana_data:/var/lib/grafana
      # Mount provisioning files to auto-configure Loki datasource
      - ./grafana/provisioning/:/etc/grafana/provisioning/:ro
      # Mount dashboards for version control (read-write)
      - ./dashboards:/etc/grafana/dashboards
    environment:
      # Set admin user/pass (change 'your_strong_password')
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=your_strong_password
      # Skip update checks for local instance
      - GF_UPDATE_CHECKING_ENABLED=false
      # Dashboard settings
      # - GF_DASHBOARDS_MIN_REFRESH_INTERVAL=1s
      # - GF_DASHBOARDS_VERSIONS_TO_KEEP=20
      # Optional: allow anonymous access if needed (use with caution)
      # - GF_AUTH_ANONYMOUS_ENABLED=true
      # - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    networks:
      - logging
    depends_on:
      - loki
    restart: unless-stopped